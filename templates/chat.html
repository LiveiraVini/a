<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chatbot Especialista</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>

<body>
    <div class="container-fluid vh-100">
        <div class="row h-100">

            <div class="col-md-4 col-lg-3 bg-white border-end p-3">
                <h5 class="mb-3 text-center">Contatos</h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary">Maria</button>
                    <button class="btn btn-outline-primary">João</button>
                    <button class="btn btn-outline-primary">Ana</button>
                    </div>
            </div>

            <div class="col-md-8 col-lg-9 d-flex flex-column p-3">
                
                <div class="flex-grow-1 bg-light rounded shadow-sm p-3 overflow-auto" id="messages-area">
                    <div class="text-muted small mb-2">Hoje</div>

                    <div class="d-flex flex-column">
                        <div class="align-self-start bg-primary text-white p-2 rounded-3 mb-2" style="max-width: 70%;">
                            Oi! Tudo bem?
                        </div>
                    </div>
                </div>

                <div class="mt-3 d-flex">
                    <input type="text" class="form-control me-2" id="message-input" placeholder="Digite sua pergunta para o especialista...">
                    <button class="btn btn-primary" id="send-button">Enviar</button>
                </div>
            </div>

        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>

    <script>
        // O código para conectar o front-end ao seu Flask /send_message
        // --- Código JavaScript para o chat.html ---
document.addEventListener('DOMContentLoaded', () => {
    // 1. Seleciona os elementos da interface
    const inputField = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const messagesArea = document.getElementById('messages-area');

    sendButton.addEventListener('click', sendMessage);

    // Também permite enviar a mensagem ao pressionar 'Enter'
    inputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // 3. Define a função de envio assíncrona
    async function sendMessage() {
        const userMessage = inputField.value.trim();
        if (userMessage === "") return;

        // 3a. Exibe a mensagem do usuário imediatamente no chat
        appendMessage(userMessage, 'user');
        inputField.value = ''; // Limpa o campo

        try {
            // Configuração da requisição POST para o Flask
            const response = await fetch('/send_message', {
                method: 'POST',
                // CRÍTICO: Indica ao Flask que o corpo é JSON
                headers: {
                    'Content-Type': 'application/json',
                },
                // Converte a mensagem em uma string JSON para o Flask
                body: JSON.stringify({ message: userMessage }),
            });

            const data = await response.json();

            // 4. Trata e exibe a resposta do Flask (que contém o resultado da triagem)
            if (response.ok && data.status === 'success') {
                appendMessage(data.response_text, 'expert');
                console.log(`Classificado como: ${data.area_classified}`);
            } else {
                appendMessage("Erro: Não foi possível processar sua solicitação no momento.", 'expert');
            }

        } catch (error) {
            console.error('Erro de rede:', error);
            appendMessage("Erro: Falha na conexão com o servidor.", 'expert');
        }
    }

    // Função auxiliar para adicionar mensagens ao DOM
    function appendMessage(text, sender) {
        const isUser = sender === 'user';
        const messageContainer = document.createElement('div');
        messageContainer.className = 'd-flex flex-column';
        
        const messageBubble = document.createElement('div');
        
        // Estilização com Bootstrap (cores e alinhamento)
        messageBubble.className = `p-2 rounded-3 mb-2 text-white ${isUser ? 'align-self-end bg-secondary' : 'align-self-start bg-primary'}`;
        messageBubble.style.maxWidth = '70%';
        
        // Permite o uso de Markdown simples (como **negrito** na resposta da LLM)
        messageBubble.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        messageContainer.appendChild(messageBubble);
        messagesArea.appendChild(messageContainer);
        
        // Rola para o final
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }
});
    </script>
</body>

</html>